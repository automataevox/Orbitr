version: '3.8'

services:
  orbitr:
    image: orbitr/orbitr:latest
    container_name: orbitr
    restart: unless-stopped
    
    ports:
      - "${ORBITR_PORT:-3000}:3000"
    
    volumes:
      # Data persistence
      - orbitr-data:/app/data
      
      # Extension storage
      - orbitr-extensions:/app/extensions
      
      # Logs
      - orbitr-logs:/app/logs
      
      # Docker socket (read-only for security)
      - /var/run/docker.sock:/var/run/docker.sock:ro
    
    environment:
      # ========================================
      # CORE CONFIGURATION
      # ========================================
      - NODE_ENV=production
      - PORT=3000
      - DATABASE_URL=file:/app/data/orbitr.db
      
      # ========================================
      # ORBITR CONFIGURATION
      # ========================================
      # Base URL for generating links
      - BASE_URL=${BASE_URL:-http://localhost:3000}
      
      # Log level: debug, info, warn, error
      - LOG_LEVEL=${LOG_LEVEL:-info}
      
      # ========================================
      # DOCKER CONFIGURATION
      # ========================================
      - DOCKER_SOCKET=/var/run/docker.sock
      - DOCKER_NETWORK=orbitr-network
      
      # ========================================
      # REVERSE PROXY CONFIGURATION
      # ========================================
      # Type: traefik or caddy
      - PROXY_TYPE=${PROXY_TYPE:-traefik}
      
      # Your domain (for SSL)
      - DOMAIN=${DOMAIN:-localhost}
      
      # Email for Let's Encrypt
      - SSL_EMAIL=${SSL_EMAIL:-}
      
      # Enable automatic SSL
      - AUTO_SSL=${AUTO_SSL:-false}
      
      # ========================================
      # AUTHENTICATION (Optional)
      # ========================================
      # - NEXTAUTH_URL=${NEXTAUTH_URL:-http://localhost:3000}
      # - NEXTAUTH_SECRET=${NEXTAUTH_SECRET:-}
      
      # ========================================
      # NOTIFICATIONS (Optional)
      # ========================================
      # Discord webhook URL
      # - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL:-}
      
      # Slack webhook URL
      # - SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL:-}
      
      # ========================================
      # BACKUP CONFIGURATION (Optional)
      # ========================================
      # S3-compatible backup storage
      # - BACKUP_S3_ENDPOINT=${BACKUP_S3_ENDPOINT:-}
      # - BACKUP_S3_BUCKET=${BACKUP_S3_BUCKET:-}
      # - BACKUP_S3_ACCESS_KEY=${BACKUP_S3_ACCESS_KEY:-}
      # - BACKUP_S3_SECRET_KEY=${BACKUP_S3_SECRET_KEY:-}
      
      # ========================================
      # ADVANCED SETTINGS
      # ========================================
      # Enable experimental features
      - EXPERIMENTAL_FEATURES=${EXPERIMENTAL_FEATURES:-false}
      
      # Enable debug mode
      - DEBUG=${DEBUG:-false}
    
    # Add user to docker group for socket access
    group_add:
      - ${DOCKER_GID:-999}
    
    networks:
      - orbitr-network
    
    labels:
      - "orbitr.managed=false"
      - "com.centurylinklabs.watchtower.enable=true"
    
    depends_on:
      - traefik
  
  # ============================================================================
  # REVERSE PROXY (Traefik)
  # ============================================================================
  traefik:
    image: traefik:v2.10
    container_name: orbitr-traefik
    restart: unless-stopped
    
    command:
      # API and dashboard
      - "--api.dashboard=false"
      
      # Docker provider
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=orbitr-network"
      
      # File provider for dynamic configuration
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--providers.file.watch=true"
      
      # Entry points
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      
      # Automatic HTTPS redirect
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      
      # Let's Encrypt (if SSL_EMAIL is set)
      - "--certificatesresolvers.letsencrypt.acme.email=${SSL_EMAIL:-}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/acme/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      
      # Logging
      - "--log.level=${TRAEFIK_LOG_LEVEL:-INFO}"
      - "--accesslog=true"
    
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
    
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-acme:/acme
      - traefik-config:/etc/traefik/dynamic
    
    networks:
      - orbitr-network
    
    labels:
      - "orbitr.managed=true"
      - "orbitr.component=proxy"

networks:
  orbitr-network:
    name: orbitr-network
    driver: bridge
    labels:
      - "orbitr.network=true"

volumes:
  orbitr-data:
    name: orbitr-data
    labels:
      - "orbitr.volume=data"
  
  orbitr-extensions:
    name: orbitr-extensions
    labels:
      - "orbitr.volume=extensions"
  
  orbitr-logs:
    name: orbitr-logs
    labels:
      - "orbitr.volume=logs"
  
  traefik-acme:
    name: traefik-acme
    labels:
      - "orbitr.volume=traefik-acme"
  
  traefik-config:
    name: traefik-config
    labels:
      - "orbitr.volume=traefik-config"
